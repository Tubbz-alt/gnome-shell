Description: Enable GL/GLX bits conditionally
 This avoids a build failure on arm{el,hf} where cogl uses GLES
Author: Michael Biebl <biebl@debian.org>
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=670850
Index: gnome-shell-3.4.1/configure.ac
===================================================================
--- gnome-shell-3.4.1.orig/configure.ac	2012-05-30 20:30:08.173590415 +0200
+++ gnome-shell-3.4.1/configure.ac	2012-05-30 20:30:08.741590395 +0200
@@ -50,7 +50,7 @@
    AC_MSG_RESULT(yes)
    build_recorder=true
    recorder_modules="gstreamer-0.10 gstreamer-base-0.10 x11"
-   PKG_CHECK_MODULES(TEST_SHELL_RECORDER, $recorder_modules clutter-1.0 xfixes gl)
+   PKG_CHECK_MODULES(TEST_SHELL_RECORDER, $recorder_modules clutter-1.0 xfixes)
 else
    AC_MSG_RESULT(no)
 fi
@@ -82,7 +82,6 @@
                                gjs-internals-1.0 >= $GJS_MIN_VERSION
 			       libgnome-menu-3.0 $recorder_modules
                                gdk-x11-3.0 libsoup-2.4
-                               gl
 			       clutter-x11-1.0 >= $CLUTTER_MIN_VERSION
 			       clutter-glx-1.0 >= $CLUTTER_MIN_VERSION
                                libstartup-notification-1.0 >= $STARTUP_NOTIFICATION_MIN_VERSION
@@ -133,6 +132,16 @@
 
 PKG_CHECK_MODULES(BROWSER_PLUGIN, gio-2.0 >= $GIO_MIN_VERSION json-glib-1.0 >= 0.13.2)
 
+PKG_CHECK_MODULES(GLX, [gl], [have_glx=yes], [have_glx=no])
+if test "x$have_glx" = "xyes"; then
+   GNOME_SHELL_CFLAGS="$GNOME_SHELL_CFLAGS $GLX_CFLAGS"
+   GNOME_SHELL_LIBS="$GNOME_SHELL_LIBS $GLX_LIBS"
+   TEST_SHELL_RECORDER_CFLAGS="$TEST_SHELL_RECORDER_CFLAGS $GLX_CFLAGS"
+   TEST_SHELL_RECORDER_LIBS="$TEST_SHELL_RECORDER_LIBS $GLX_LIBS"
+   AC_DEFINE(HAVE_GLX, [1], [Define if we have GLX])
+   AC_SUBST([HAVE_GLX], [1])
+fi
+
 GJS_VERSION=`$PKG_CONFIG --modversion gjs-internals-1.0`
 AC_DEFINE_UNQUOTED([GJS_VERSION], ["$GJS_VERSION"], [The version of GJS we're linking to])
 AC_SUBST([GJS_VERSION], ["$GJS_VERSION"])
Index: gnome-shell-3.4.1/src/gnome-shell-plugin.c
===================================================================
--- gnome-shell-3.4.1.orig/src/gnome-shell-plugin.c	2012-03-09 22:42:49.000000000 +0100
+++ gnome-shell-3.4.1/src/gnome-shell-plugin.c	2012-05-30 20:30:08.741590395 +0200
@@ -30,8 +30,10 @@
 
 #include <clutter/clutter.h>
 #include <clutter/x11/clutter-x11.h>
+#ifdef HAVE_GLX
 #include <GL/glx.h>
 #include <GL/glxext.h>
+#endif
 #include <gjs/gjs.h>
 #include <meta/display.h>
 #include <meta/meta-plugin.h>
@@ -146,14 +148,17 @@
 gnome_shell_plugin_start (MetaPlugin *plugin)
 {
   GnomeShellPlugin *shell_plugin = GNOME_SHELL_PLUGIN (plugin);
+#ifdef HAVE_GLX
   MetaScreen *screen;
   MetaDisplay *display;
   Display *xdisplay;
+  const char *glx_extensions;
+#endif
   GError *error = NULL;
   int status;
-  const char *glx_extensions;
   GjsContext *gjs_context;
 
+#ifdef HAVE_GLX
   screen = meta_plugin_get_screen (plugin);
   display = meta_screen_get_display (screen);
 
@@ -166,6 +171,9 @@
   glx_extensions = glXQueryExtensionsString (xdisplay,
                                              meta_screen_get_screen_number (screen));
   shell_plugin->have_swap_event = strstr (glx_extensions, "GLX_INTEL_swap_event") != NULL;
+#else
+  shell_plugin->have_swap_event = 0;
+#endif
 
   shell_perf_log_define_event (shell_perf_log_get_default (),
                                "glx.swapComplete",
Index: gnome-shell-3.4.1/src/shell-screen-grabber.c
===================================================================
--- gnome-shell-3.4.1.orig/src/shell-screen-grabber.c	2012-03-02 13:28:41.000000000 +0100
+++ gnome-shell-3.4.1/src/shell-screen-grabber.c	2012-05-30 20:30:55.781588732 +0200
@@ -1,21 +1,27 @@
 /* -*- mode: C; c-file-style: "gnu"; indent-tabs-mode: nil; -*- */
 
+#include "config.h"
+
 #include <string.h>
 
 #include <clutter/clutter.h>
 #include <cogl/cogl.h>
+#ifdef HAVE_GLX
 #include <GL/gl.h>
 #include <GL/glx.h>
 #include <GL/glext.h>
+#endif
 
 #include "shell-screen-grabber.h"
 
+#ifdef HAVE_GLX
 PFNGLBINDBUFFERARBPROC pf_glBindBufferARB;
 PFNGLBUFFERDATAARBPROC pf_glBufferDataARB;
 PFNGLDELETEBUFFERSARBPROC pf_glDeleteBuffersARB;
 PFNGLGENBUFFERSARBPROC pf_glGenBuffersARB;
 PFNGLMAPBUFFERARBPROC pf_glMapBufferARB;
 PFNGLUNMAPBUFFERARBPROC pf_glUnmapBufferARB;
+#endif
 
 struct _ShellScreenGrabberClass
 {
@@ -39,8 +45,10 @@
 {
   ShellScreenGrabber *grabber = SHELL_SCREEN_GRABBER (gobject);
 
+#ifdef HAVE_GLX
   if (grabber->pixel_buffer != 0)
     pf_glDeleteBuffersARB (1, &grabber->pixel_buffer);
+#endif
 }
 
 static void
@@ -95,6 +103,7 @@
   data_size = row_bytes * height;
   data = g_malloc (data_size);
 
+#ifdef HAVE_GLX
   if (grabber->have_pixel_buffers == -1)
     {
       const GLubyte* extensions = glGetString (GL_EXTENSIONS);
@@ -198,6 +207,7 @@
         glPixelStorei (GL_PACK_INVERT_MESA, old_pack_invert);
     }
   else
+#endif /* HAVE_GLX */
     {
       cogl_read_pixels (x, y,
                         width, height,
